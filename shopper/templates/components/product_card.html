{% load custom_filters %}
{% load static %}

<div class="card bg-white border border-neutral-200 hover:shadow-md">

    <div class="h-[212px] w-full flex justify-center rounded-2xl overflow-hidden">
        {% if reserved %}
        <a href="{% url 'reservation-details' reservation_id=reserved.id %}" class="flex justify-center w-full">
            {% if reserved.variant.variantimage_set.first.image %}
            <img src=" {{ reserved.variant.variantimage_set.first.image.url }}" class="w-auto h-full" />
            {% elif reserved.variant.image %}
            <img src="{{ reserved.variant.image.url }}" class="w-auto h-full" />
            {% else %}
            <img src="{% static 'img/no-image.png' %}" class="w-auto h-full" />
            {% endif %}
        </a>
        {% else %}
        {% if 'shopping' in request.path %}
        <div class="w-full flex justify-center">
            {% if product.image %}
            <img src="{% static 'img/shopping_center/'|add:product.image.url %}" class="w-auto h-full" />
            {% else %}
            <img src="{% static 'img/no-image.png' %}" class="w-auto h-full" />
            {% endif %}
        </div>
        {%else%}
        <a href="{% url 'products' product_id=product.id %}" class="w-full flex justify-center">
            {% if product.variants.first.variantimage_set.first.image %}
            <img src="{{ product.variants.first.variantimage_set.first.image.url }}" class="w-auto h-full" />
            {% else %}
            <img src="{% static 'img/no-image.png' %}" class="w-auto h-full" />
            {% endif %}
        </a>
        {% endif %}
        {% endif %}
    </div>
    <div class="relative">
        {% if not reserved %}
        <span class="absolute -top-[210px] right-2 mt-2 mr-2 rounded-full p-1 cursor-pointer bg-w-light-smooth-gray"
            id="favorite-span_{{ product.id }}{{device}}{{ slider }}" onclick="favoriteBtn(this)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-6 h-6 text-white favorite stroke-red-600"
                id="favorite_{{ product.id }}{{device}}{{ slider }}">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
            </svg>
        </span>
        {% endif %}
        <div
            class="absolute -top-[200px] left-3 badge bg-w-indigo border-w-indigo {% if not reserved %}hidden{% endif %} px-1 py-3">
            <div class="flex text-white text-xs font-normal items-center gap-1">
                <div class="flex items-center">
                    <span class="pl-1">{{ reserved.time_limit|minutes_until_datetime }}</span>
                </div>

                <div class="flex items-center gap-1">
                    <span> left</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body px-3.5 py-3">
        <div class="space-y-1">
            {% if reserved %}
            <a href="{% url 'reservation-details' reservation_id=reserved.id %}">
                <div class="card-title font-medium text-neutral-800 text-2xl">${{ reserved.total }}</div>
                {% if reserved.variant.product.variants.all|length == 1 %}
                <div class="font-medium text-neutral-800 text-base line-clamp-1">
                    {{reserved.variant.product.name }}
                </div>
                {% else %}
                <div class="font-medium text-neutral-800 text-base line-clamp-1">{{ reserved.variant.name }}</div>
                {% endif %}
            </a>
            <a
                href="{% url 'retailer-details' retailer_id=reserved.variant.product.inventory.location.retailer.id %}?origin=reservations">
                <div class="flex items-center gap-1 text-base text-w-blue mt-1">
                    <span class="material-icons-outlined">
                        storefront
                    </span>
                    <div class="font-normal underline line-clamp-1">
                        {{ reserved.variant.product.inventory.location.retailer.name }}
                    </div>
                </div>
            </a>
            {% else %}
            {% if 'shopping' in request.path %}
            <div>
                {% if product.variants.all|length == 1 %}
                <div class="card-title font-medium text-neutral-800 text-2xl">${{ product.variants.first.price }}</div>
                {% elif product.min_price != product.max_price %}
                <div class="card-title font-medium text-neutral-800 text-2xl">
                    ${{ product.min_price }} - ${{ product.max_price }}
                </div>
                {% else %}
                <div class="card-title font-medium text-neutral-800 text-2xl">
                    ${{ product.min_price }}
                </div>
                {% endif %}
                <div class="font-medium text-neutral-800 text-base line-clamp-1">{{ product.name }}</div>
            </div>
            {%else%}
            <a href="{% url 'products' product_id=product.id %}">
                {% if product.variants.all|length == 1 %}
                <div class="card-title font-medium text-neutral-800 text-2xl">${{ product.variants.first.price }}</div>
                {% elif product.min_price != product.max_price %}
                <div class="card-title font-medium text-neutral-800 text-2xl">
                    ${{ product.min_price }} - ${{ product.max_price }}
                </div>
                {% else %}
                <div class="card-title font-medium text-neutral-800 text-2xl">
                    ${{ product.min_price }}
                </div>
                {% endif %}
                <div class="font-medium text-neutral-800 text-base line-clamp-1">{{ product.name }}</div>
            </a>
            {% endif %}
            {% if product.inventory %}
            <a href="{% url 'retailer-details' retailer_id=product.inventory.location.retailer.id %}?origin=/">
                <div class="flex items-center gap-1 text-base text-w-blue mt-1">
                    <span class="material-icons-outlined">
                        storefront
                    </span>
                    <div class="font-normal underline line-clamp-1">
                        {{ product.inventory.location.retailer.name }}
                    </div>
                </div>
            </a>
            {% else %}
            <div class="flex items-center gap-1 text-base text-w-blue mt-1">
                <span class="material-icons-outlined">
                    storefront
                </span>
                <div class="font-normal underline">
                    Retailer name
                </div>
            </div>
            {% endif %}
            {% endif %}

        </div>
        {% if "retailers" not in request.path %}
        {% if product.inventory %}
        <div class="font-normal text-sm opacity-50 text-neutral-800 !line-clamp-2 h-14 flex items-center">
            {{ product.inventory.location.address1 }}
            {% if product.inventory.location.address2 %},
            {{ product.inventory.location.address2 }}
            {% endif %}
            {% if product.inventory.location.city %}
            {{ product.inventory.location.city }},
            {% endif %}
            {% if product.inventory.location.zip_code %}
            {{ product.inventory.location.zip_code }}
            {% endif %}
        </div>
        {% elif reserved %}
        <div class="font-normal text-sm opacity-50 text-neutral-800 !line-clamp-2 h-14 flex items-center">
            {{ res.variant.product.inventory.location.address1 }}
            {% if res.variant.product.inventory.location.address2 %}
            {{ res.variant.product.inventory.location.address2 }}
            {% endif %}
            {% if res.variant.product.inventory.location.city %}
            {{ res.variant.product.inventory.location.city }}
            {% endif %}
            {% if res.variant.product.inventory.location.zip_code %}
            {{ res.variant.product.inventory.location.zip_code }}
            {% endif %}
        </div>
        {% else %}
        <div class="font-normal text-sm opacity-50 text-neutral-800 !line-clamp-2 h-9 flex items-center">
            {{ product.address }}
        </div>
        {% endif %}
        {% endif %}
        <div class="flex items-center h-4 mt-1">
            <div class="font-normal text-sm text-neutral-800 pr-4">Reliability Score</div>
            {% if reserved %}
            {% with product_stock=reserved.variant|calculate_reliability_score %}
            {% if product_stock < 1 %} <progress class="progress-bar progress-bar-danger w-16 h-4" value="33" max="100" id="score">
                </progress>
                {% elif product_stock == 1 %}
                <progress class="progress-bar progress-bar-warning w-16 h-4" value="66" max="100" id="score"></progress>
                {% else %}
                <progress class="progress-bar progress-bar-success w-16 h-4" value="100" max="100" id="score"></progress>
                {% endif %}
                {% endwith %}
                {% else %}
                {% with product_stock=product|calculate_reliability_score %}                
                {% if product_stock < 1 %} <!-- <progress class="progress bar-danger w-16 h-4 bg-neutral-200" value="33"
                    max="100"></progress> -->
                    <progress class="progress-bar progress-bar-danger w-16 h-4" value="33" 
                        max="100" id="score"></progress>
                    {% elif product_stock == 1 %}
                    <!-- <progress class="progress bar-warning w-16 h-4 bg-neutral-200" value="66" max="100"></progress> -->
                    <progress class="progress-bar progress-bar-warning w-16 h-4" value="66" 
                        max="100" id="score"></progress>
                    {% else %}
                    <!-- <progress class="progress bar-success w-16 h-4 bg-neutral-200" value="100" max="100"></progress> -->
                    <progress class="progress-bar progress-bar-success w-16 h-4" value="100" 
                        max="100" id="score"></progress>
                    {% endif %}
                    {% endwith %}
                    {% endif %}
        </div>

        <div class="card-actions justify-center gap-4 flex-col items-center pt-2 pb-1">
            {% if reserved %}
            <div class="bg-w-light-gray rounded-lg w-full px-3 py-2">
                <div class="font-normal text-sm text-neutral-800">
                    Reserved quantity: {{ reserved.quantity }}
                </div>
                <div class="font-normal text-sm text-neutral-800 opacity-50 flex items-center gap-1">
                    <span>Reservation code</span>
                    <span>{{ reserved.reservation_code }}</span>
                </div>
            </div>
            <a href="{% url 'reservation-details' reservation_id=reserved.id %}"
                class=" bg-w-primary text-white text-sm font-semibold border-w-light-gray rounded-full h-10 flex items-center justify-center btn-block"
                id="details_{{ product.id }}">
                Reservation details
            </a>
            {% elif product.variants.all|length > 1 %}
            <div class="font-normal text-neutral-800 text-xs pt-1 pb-1 sm:pt-0 sm:pb-0 sm:text-sm">
                This product contains variations that may change the price
            </div>
            <a href="{% url 'products' product_id=product.id %}"
                class="mt-0.5 bg-w-primary text-white text-sm font-semibold capitalize border-w-light-gray rounded-full h-10 flex items-center justify-center btn-block"
                id="more_{{ product.id }}">
                Select
            </a>
            {% else %}
            <form action="{% url 'make-reservation' product_id=product.id %}" method="post" class="w-full"
                id="make-res_{{ product.id }}{{ slider }}{{device}}">
                {% csrf_token %}
                <div class="flex items-center gap-4 justify-center">
                    <button type="button" class="rounded-full bg-w-primary p-2 disabled:bg-w-light-gray minus-btn"
                        id="minus_{{ product.id }}{{ device }}{{ slider }}" onclick="minusBtn(this)" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                            class="w-6 h-6 text-white">
                            <path fill-rule="evenodd"
                                d="M3.75 12a.75.75 0 01.75-.75h15a.75.75 0 010 1.5h-15a.75.75 0 01-.75-.75z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                    <input type="text" name="quantity" id="quantity_{{ product.id }}{{ device }}{{ slider }}" min="1"
                        readonly max="500"
                        class="w-12 border border-neutral-800 appearance-none rounded-xl text-center text-neutral-800 disabled:bg-white"
                        value="{% if reserved %}{{ product.reserved_quantity }}{% else %}1{% endif %}">
                    <button type="button" class="rounded-full bg-w-primary p-2 plus-btn disabled:bg-w-light-gray"
                        id="plus_{{ product.id }}{{ device }}{{ slider }}" onclick="plusBtn(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                            class="w-6 h-6 text-white">
                            <path fill-rule="evenodd"
                                d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <button type="button" onclick="reserveBtn(this)"
                    class="mt-4 bg-w-primary text-white btn-block text-sm font-semibold capitalize border-w-light-gray rounded-full h-10"
                    id="reserve_{{ product.id }}{{ slider }}{{device}}">
                    Reserve
                </button>
                {% endif %}
            </form>
        </div>
    </div>
</div>